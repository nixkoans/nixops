# NixOS on linode

Implementing with GPT, BIOS, Grub2 boot loader in linode's KVM environment, direct disk boot

## Prepare the disk with appropriate partitions

```
gdisk /dev/sda
```

Here's the partitions I created:

```
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048            4095   1024.0 KiB  EF02  BIOS boot partition
   2            4096         1028095   500.0 MiB   8300  Linux filesystem
   3         1028096         3125247   1024.0 MiB  8200  Linux swap
   4         3125248        50331614   22.5 GiB    8300  Linux filesystem
```

After creating the partitions with gdisk, let's format them:

```
mkfs.ext4 -L nixos /dev/sda4
mkfs.ext4 -L boot /dev/sda2
mkswap -L swap /dev/sda3
swapon /dev/sda3  # switch on the swap partition so nixos-install doesn't fail with out of memory error
```

## Boot into finnix rescue disk on linode

```
mount /dev/sda4 /mnt
mkdir -p /mnt/boot
mount /dev/sda2 /mnt/boot
swapon /dev/sda3
```

## Bootstrap nix installers

```
adduser nix

groupadd -r nixbld # we need the Nix build users
for n in $(seq 1 10); do useradd -c "Nix build user $n" \
-d /var/empty -g nixbld -G nixbld -M -N -r -s "$(which nologin)" \
nixbld$n; done

mkdir /nix
chown -R nix /nix
su - nix
bash <(curl https://nixos.org/nix/install)
exit # exit back as root user in finnix

# We can continue doing this as root in finnix
. ~nix/.nix-profile/etc/profile.d/nix.sh
nix-channel --remove nixpkgs
nix-channel --add http://nixos.org/channels/nixos-14.12 nixos
nix-channel --update

# Install vim so we can use it for editing the configuration.nix later
nix-env -i vim

# temporary configuration.nix
cat <<EOF > configuration.nix
{ fileSystems."/" = {};
boot.loader.grub.enable = false;
}
EOF

# Now we have the nixos-install, nixos-generate-config etc tools for us to bootstrap our disks
export NIX_PATH=nixpkgs=/root/.nix-defexpr/channels/nixos:nixos=/root/.nix-defexpr/channels/nixos/nixos
export NIXOS_CONFIG=/root/configuration.nix
nix-env -i -A config.system.build.nixos-install -A config.system.build.nixos-option -A config.system.build.nixos-generate-config -f "<nixos>"

# Generate configuration.nix on our target disks
export NIX_PATH=nixpkgs=/root/.nix-defexpr/channels/nixos:nixos=/root/.nix-defexpr/channels/nixos/nixos
nixos-generate-config --root /mnt
```

## Make sure that we have the correct kernel modules for KVM

Update your `/mnt/etc/nixos/hardware-configuration.nix` to:

```
# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, ... }:

{
  imports =
    [ <nixpkgs/nixos/modules/installer/scan/not-detected.nix>
    ];

  # we can also update the imports line above to
  # <nixpkgs/nixos/modules/profiles/qemu-guest.nix> above and
  # if so we do not need the 3 `boot.initrd.**` lines of config below
  boot.initrd.availableKernelModules = [
    "virtio_net" "virtio_pci" "virtio_blk" "9p" "9pnet_virtio" "virtio_scsi"
  ];
  boot.initrd.kernelModules = [ "virtio_balloon" "virtio_console" "virtio_rng" ]
;
  boot.initrd.postDeviceCommands =
    ''
      # Set the system time from the hardware clock to work around a
      # bug in qemu-kvm > 1.5.2 (where the VM clock is initialised
      # to the *boot time* of the host).
      hwclock -s
    '';

  boot.kernelModules = [ "kvm_intel" ];
  boot.kernelParams = [ "console=ttyS0" ];
  boot.extraModulePackages = [ ];

  # These will be different for your case, obviously, because nixos-generate-config will detect
  # your disk partitions' uuid
  fileSystems."/" =
    { device = "/dev/disk/by-uuid/fcc83595-d1ba-416e-840c-54e4c2c8b387";
      fsType = "ext4";
    };

  fileSystems."/boot" =
    { device = "/dev/disk/by-uuid/213be7c4-a1f8-443f-a1f2-a0cf799c0c76";
      fsType = "ext4";
    };

  swapDevices =
    [ { device = "/dev/disk/by-uuid/f437d8a0-ac18-428e-a90a-730840ca6cfc"; }
    ];

  nix.maxJobs = 1;
}
```

## Install!

```
unset NIXOS_CONFIG
nixos-install
```
